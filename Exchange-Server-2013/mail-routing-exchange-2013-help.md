---
title: '邮件路由: Exchange 2013 Help'
TOCTitle: 邮件路由
ms:assetid: 6fd39079-9655-4fd9-9269-c7462c76e0a7
ms:mtpsurl: https://technet.microsoft.com/zh-cn/library/Aa998825(v=EXCHG.150)
ms:contentKeyID: 50490804
ms.date: 01/11/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# 邮件路由

 

_**适用于：** Exchange Server 2013_

_**上一次修改主题：** 2015-03-09_

Microsoft Exchange Server 2013 组织中所有邮箱服务器上存在的传输服务的主要任务是将接收自用户和外部来源的邮件路由到最终目标。路由决策在邮件分类期间做出。分类程序是邮箱服务器上的传输服务的一个组件，处理所有传入邮件并根据有关目标的信息确定要对邮件执行的操作。

Exchange 2013 中的路由现在完全了解数据库可用性组 (DAG)，并使用 DAG 成员资格作为路由边界。为什么？在 Exchange 2013 中，所有邮箱服务器都托管传输服务。因此，当邮箱服务器属于 DAG 时，用于路由邮件的主要机制与 DAG 非常接近。并且当 DAG 跨多个 Active Directory 站点时，使用 Active Directory 站点作为主要路由边界的效率较低。Exchange 2013 还将 Active Directory 站点成员资格用作不属于 DAG 的邮箱服务器的路由边界，并用于与以前版本的 Exchange 的路由互操作性。对 Exchange 2013 路由进行的其他显著更改包括：

  - 邮箱服务器上的传输服务从不直接与邮箱数据库通信。而是传输服务与邮箱服务器上的邮箱传输服务进行通信。只有邮箱传输服务才与本地邮箱服务器上的邮箱数据库通信。当邮箱服务器是 DAG 的成员时，只有保存邮箱数据库主动副本的邮箱服务器上的邮箱传输服务才会接受目标收件人的邮件。

  - 远程过程调用 (RPC) 仅由邮箱传输服务在向本地邮箱数据库发送邮件或从本地邮箱数据库接收邮件时使用。当邮箱服务器是 DAG 的成员时，邮箱传输服务仅使用 RPC 与邮箱数据库的主动副本进行本地通信。换句话说，RPC 从不用于跨服务器通信。而是不同邮箱服务器上的邮箱传输服务和传输服务始终使用 SMTP 进行通信。

  - Exchange 2013 对远程目标使用更加精确的排队。Exchange 2013 针对 Active Directory 站点中的特定目标（如各个发送连接器）对邮件排队，而不是将一个队列用于远程 Active Directory 站点中的所有目标。

  - 链接连接器已弃用。链接连接器是链接到发送连接器的接收连接器。接收连接器接收的所有邮件都自动转发到发送连接器。

**目录**

路由组件

  - 路由目标

  - 传递组

  - 队列

路由邮件

  - 在 Active Directory 站点之间路由邮件

  - 在客户端访问服务器上的前端传输服务中路由

  - 在邮箱服务器上的邮箱传输服务中路由

  - 在边缘传输服务器上的传输服务中路由

## 路由组件

Exchange 2013 邮箱服务器上的传输服务收到邮件后，必须对邮件进行分类。邮件分类的第一个阶段是收件人解析。解析了收件人之后，可以确定最终目标。下一个阶段是路由，确定到达该目标的最佳路径。通过引入路由目标和传递组的概念对 Exchange 2013 中的路由进行了一般化，以提高灵活性并降低复杂性。

## 路由目标

在 Exchange 2013 中，邮件的最终目标称为“路由目标”。Exchange 2013 中存在以下路由目标：

  - **邮箱数据库**   这是在 Exchange 组织中的邮箱服务器上拥有邮箱的任何收件人的路由目标。在 Exchange 2013 中，公用文件夹是一种邮箱类型，因此将邮件路由到公用文件夹收件人与将邮件路由到邮箱收件人是相同的。

  - **连接器**   连接器在用作路由目标时是 SMTP 邮件的发送连接器。传递代理连接器或外部连接器用作非 SMTP 邮件的路由目标。

  - **通讯组扩展服务器**   当通讯组具有负责展开组的成员资格列表的指定扩展服务器时，这是路由目标。通讯组扩展服务器始终为集线器传输服务器或 Exchange 2013 邮箱服务器。

请注意，以前版本的 Exchange 中也存在这些相同的路由目标。

返回顶部

## 传递组

Exchange 2013 中的每个路由目标都具有包含一个或多个传输服务器的集合，这些服务器负责将邮件传递到该路由目标。此传输服务器集合称为“传递组”。传输服务器可以是 Exchange 2013 邮箱服务器，或是安装了集线器传输服务器角色的 Exchange 2010 服务器或 Exchange 2007 服务器。当路由目标为邮箱数据库时，传递组中的传输服务器所用的 Exchange 版本与邮箱数据库所用的版本相同。当路由目标为连接器或通讯组扩展服务器时，传递组可以包含 Exchange 2013 邮箱服务器和 Exchange 2010 或 Exchange 2007 集线器传输服务器的混合。邮件的路由方式取决于源传输服务器与目标传递组之间的关系：

  - 如果源传输服务器处于目标传递组中，则路由目标本身是邮件的下一个跃点。邮件由源传输服务器传递给传递组中传输服务器上的邮箱数据库或连接器。请注意，当通讯组扩展服务器为路由目标时，通讯组已在邮件到达通讯组扩展服务器上的分类路由阶段时展开。因此，来自通讯组扩展服务器的路由目标始终为邮箱数据库或连接器。

  - 如果源传输服务器处于目标传递组外部，则邮件会沿最低成本路由路径中继到目标传递组。根据 Exchange 拓扑的大小和复杂性，邮件会沿最低成本路由路径中继到其他传输服务器，或是邮件会直接中继到目标传递组中的传输服务器。

Exchange 2013 中存在以下传递组类型：

  - **可路由 DAG**   这是属于 DAG 的 Exchange 2013 邮箱服务器的集合。DAG 中的邮箱数据库是由此传递组提供服务的路由目标。在邮件到达属于 DAG 的邮箱服务器上的传输服务之后，传输服务会将邮件路由到 DAG 中当前保存目标邮箱数据库主动副本的邮箱服务器上的邮箱传输服务。目标邮箱服务器上的邮箱传输服务随后会将邮件传递到本地邮箱数据库。尽管 DAG 可能包含位于不同 Active Directory 站点中的邮箱服务器，不过 DAG 为传递组边界。

  - **邮箱传递组**   这是位于一个 Active Directory 站点中的相同版本的 Exchange 服务器集合。Active Directory 站点为传递组边界。路由目标以及为其提供服务的传递组由 Active Directory 站点中的主要 Exchange 发行版本分隔。位于 Exchange 2010 邮箱服务器上的邮箱数据库由位于 Active Directory 站点中的 Exchange 2010 集线器传输服务器提供服务。位于 Exchange 2007 邮箱服务器上的邮箱数据库由位于 Active Directory 站点中的 Exchange 2007 集线器传输服务器提供服务。位于 Active Directory 站点中不属于 DAG 的 Exchange 2013 邮箱服务器上的邮箱数据库由 Active Directory 站点中 Exchange 2013 邮箱服务器上的传输服务提供服务。将邮件传递到邮箱数据库的方式取决于 Exchange 的版本：
    
      - **Exchange 2013**   在邮件到达目标 Active Directory 站点中的目标邮箱服务器之后，传输服务会使用 SMTP 将邮件传输给邮箱传输服务。邮箱传输服务随后会使用 RPC 将邮件传递到本地邮箱数据库。
    
      - **Exchange 2010 或 Exchange 2007**   在邮件到达目标 Active Directory 站点中具有相同版本的随机集线器传输服务器之后，集线器传输服务器上的存储驱动程序会使用 RPC 将邮件写入邮箱数据库。

  - **连接器的源服务器**   这是范围限定为发送连接器、传递代理连接器或外部连接器的源服务器的 Exchange 2010 或 Exchange 2007 集线器传输服务器，或 Exchange 2013 邮箱服务器的混合集合。连接器是由此路由组提供服务的路由目标。当连接器的范围限定为特定服务器时，只允许该服务器将邮件路由到该连接器定义的目标。此传递组可以包含位于不同 Active Directory 站点中的 Exchange 2010 或 Exchange 2007 集线器传输服务器，或 Exchange 2013 邮箱服务器。

  - **AD 站点**   在某些情况下，Active Directory 站点不是邮件的最终目标，但是邮件必须通过该 Active Directory 站点中的 Exchange 2010 或 Exchange 2007 集线器传输服务器或 Exchange 2013 邮箱服务器进行传递。这些情况包括：
    
      - 当 Active Directory 站点配置为中心站点时。当用于传递邮件的最低成本路由路径上存在中心站点时，邮件会进行排队并由中心站点中的传输服务器进行处理，然后再中继到最终目标。
    
      - 当向 Active Directory 站点订阅边缘传输服务器时。无法从其他 Active Directory 站点直接访问这些订阅的边缘传输服务器。请注意，边缘传输服务器可能为 Exchange 2013、Exchange 2010 或 Exchange 2007。
    
    > [!NOTE]  
    > 仅当传递组为 Active Directory 站点时才使用延迟扇出。当多个收件人共享最低成本路由路径的任何部分时，延迟扇出会尝试减少邮件传输数。


  - **服务器列表**   这是配置为通讯组扩展服务器的一台或多台 Exchange 2010 或 Exchange 2007 集线器传输服务器或 Exchange 2013 邮箱服务器的集合。通讯组扩展服务器是由此传递组提供服务的路由目标。

传递组成员资格不会相互排斥。例如，作为 DAG 成员的 Exchange 2013 邮箱服务器还可以是限定范围的发送连接器的源服务器。邮箱服务器属于 DAG 中的邮箱数据库的可路由 DAG 传递组，也是限定范围的发送连接器的连接器源服务器传递组。

下表基于涉及的 Exchange 版本将路由目标映射到传递组：


<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Exchange 2013 邮箱服务器</th>
<th>Exchange 2010 或 Exchange 2007 集线器传输服务器</th>
<th>外围网络中的边缘传输服务器</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>DAG 中的邮箱数据库</p></td>
<td><p>可路由 DAG</p></td>
<td><p>邮箱传递组</p></td>
<td><p>无</p></td>
</tr>
<tr class="even">
<td><p>不在 DAG 中的邮箱数据库</p></td>
<td><p>邮箱传递组</p></td>
<td><p>邮箱传递组</p></td>
<td><p>无</p></td>
</tr>
<tr class="odd">
<td><p>连接器</p></td>
<td><p>连接器源服务器</p></td>
<td><p>连接器源服务器</p></td>
<td><p>AD 站点</p></td>
</tr>
<tr class="even">
<td><p>通讯组扩展服务器</p></td>
<td><p>服务器列表</p></td>
<td><p>服务器列表</p></td>
<td><p>无</p></td>
</tr>
</tbody>
</table>


返回顶部

## 队列

从发送服务器的角度来说，每个传递队列代表特定邮件的目标。Exchange 2013 邮箱服务器上的传输服务选择了邮件的目标后，目标将作为 **NextHopSolutionKey** 属性标记在收件人上。如果将一封邮件发送给多个收件人，则每个收件人都具有 **NextHopSolutionKey** 属性。接收服务器还执行邮件分类，并使邮件排队传递。邮件排队之后，可以检查特定队列的传递类型，以确定邮件在到达下一个跃点目标时是否将被再次中继。**NextHopSolutionKey** 属性的每个唯一值对应于单独的传递队列。

有关详细信息，请参阅[队列](queues-exchange-2013-help.md)主题中的“NextHopSolutionKey”部分。

返回顶部

## 路由邮件

当邮件需要传递到远程传递组时，必须为邮件确定路由路径。Exchange 2013 使用以下逻辑为邮件选择路由路径。此逻辑基本上与 Exchange 2010 相同：

1.  通过将到达目标必须经过的 IP 站点链接的成本相加，计算出最低成本路由路径。如果目标是连接器，则将为地址空间分配的开销加到通向所选连接器的开销中。如果有多个可能的路由路径，则使用总成本最低的路由路径。

2.  如果多个路由路径的总开销相同，将计算每个路径中的跃点数，并使用跃点数最少的路由路径。

3.  如果仍有多个可用的路由路径，则会考虑分配给目标之前的 Active Directory 站点的名称。在所使用的路由路径中，最接近目标的 Active Directory 站点的字母数字顺序最小。如果所有被评估的路由路径中与目标最接近的站点都相同，则考虑前一个站点名。

在 Exchange 2010 中，每个邮件收件人始终只与一个 Active Directory 站点关联，从源 Active Directory 站点到目标 Active Directory 站点只有一个成本最低路由。在 Exchange 2013 中，传递组可能跨多个 Active Directory 站点，并且可能存在指向这些 Active Directory 站点的多个成本最低路由路径。Exchange 2013 指定目标传递组中的一个 Active Directory 站点作为*主站点*。主站点是基于前面介绍的路由逻辑的最近 Active Directory 站点。为了在传递组之间成功路由邮件，Exchange 2013 会考虑以下问题：

  - **沿成本最低路由路径的一个或多个中心站点**   如果指向主站点的成本最低路由路径包含任何中心站点，则必须通过这些中心站点路由邮件。会选择沿成本最低路由路径的最近中心站点作为类型 **AD site**的新传递组，其中包括中心站点中的所有传输服务器。在邮件经过中心站点之后，会继续沿成本最低路由路径路由邮件。如果主站点碰巧就是中心站点，则出于以下原因仍将此主站点视为中心站点：
    
      - 如果目标传递组跨多个 Active Directory 站点，则源服务器仅应尝试连接到中心站点中的服务器。
    
      - 首选中心站点中实际属于目标传递组的服务器。
    
    与在以前版本的 Exchange 中一样，会忽略不在指向主站点的成本最低路由路径中的任何中心站点。

  - **要在目标路由组中选择的目标 Exchange 服务器**   当目标传递组跨多个 Active Directory 站点时，传递组内的特定服务器的路由路径可能具有不同的成本。会基于成本最低路由路径选择位于最近 Active Directory 站点中的服务器作为传递组的目标服务器，并且会选择这些服务器所处的 Active Directory 站点作为主站点。

  - **当尝试连接目标路由组中的所有服务器失败时的回退选项**   如果目标传递组跨多个 Active Directory 站点，则第一个回退选项是其他 Active Directory 站点的目标传递组中未选择为目标服务器的所有其他服务器。基于指向其他 Active Directory 站点的路由路径成本进行服务器选择。如果目标传递组在本地 Active Directory 站点中拥有任何服务器，则不存在任何其他回退选项，因为邮件已尽可能接近于目标路由目标。如果目标传递组在远程 Active Directory 站点中拥有服务器，则选项是尝试连接到主站点中的所有其他服务器。如果失败，则使用指向主站点的成本最低路由路径中的回退路径。Exchange 2013 通过在成本最低路由路径上逐个跃点进行回退（直到建立连接），尝试将邮件传递到尽可能接近目标的位置。

返回顶部

## 在 Active Directory 站点之间路由邮件

Exchange 2013 在 Active Directory 站点之间路由邮件的方式几乎与 Exchange 2010 相同。有关详细信息，请参阅[在 Active Directory 站点之间路由邮件](route-mail-between-active-directory-sites-exchange-2013-help.md)。

返回顶部

## 在客户端访问服务器上的前端传输服务中路由

此服务充当 Exchange 2013 组织的所有入站和（可选）出站外部 SMTP 流量的无状态代理。对于传出邮件，传输服务使用发送连接器与客户端访问服务器上的前端传输服务通信。具体而言，当适用发送连接器上的 *FrontEndProxyEnabled* 参数设置为 `$true` 时，或在 Exchange 管理中心 (EAC) 的发送连接器属性中选定“通过客户端访问服务器的代理”选项时，通过前端传输服务对传出邮件进行代理。会选择本地 Active Directory 站点中的所有客户端访问服务器。请注意，前端传输服务没有发送连接器。

对于传入的邮件，前端传输服务必须快速在邮箱服务器上找到一个状态良好的传输服务才能接收邮件传输（无论收件人的数量或类型如何）。如果未能这样，则会导致外部发件人认为电子邮件服务不可用。与传输服务一样，前端传输服务基于来自 Active Directory 的信息加载路由表，并使用传递组确定如何路由邮件。但是，前端传输服务使用的路由表具有以下独特特征：

  - 从不会将前端传输服务视为传递组的成员，即使当邮箱服务器和客户端访问服务器安装在相同物理服务器时也是如此。这会强制前端传输服务仅与传输服务通信。

  - 路由表不包含任何发送连接器路由。

  - 路由表包含本地 Active Directory 站点中邮箱服务器的特殊列表以用于快速故障转移。

前端传输服务中的路由将邮件收件人解析为邮箱数据库。前端传输服务使用的邮箱服务器的列表基于邮件收件人的邮箱数据库。请注意，可能没有任何收件人具有邮箱（例如在收件人为通讯组或邮件用户时）。对于每个邮箱数据库，前端传输服务会查找传递组和关联路由信息。前端传输服务使用的传递组为：

  - 可路由 DAG

  - 邮箱传递组

  - AD 站点

根据收件人的数量和类型，前端传输服务执行以下操作之一：

  - 对于具有单个邮箱收件人的邮件，在目标传递组中选择邮箱服务器，并基于 Active Directory 站点的临近程度向邮箱服务器分配优先权。将邮件路由到收件人可能涉及通过中心站点路由邮件。

  - 对于具有多个邮箱收件人的邮件，使用前 20 个收件人，基于 Active Directory 站点的临近程度在最近的传递组中选择邮箱服务器。请注意，不会在前端传输中进行邮件收件人拆分，因此最后只选择一个邮箱服务器（无论邮件中的收件人数如何）。

  - 如果邮件没有邮箱收件人，则在本地 Active Directory 站点中选择随机邮箱服务器。

返回顶部

## 在邮箱服务器上的邮箱传输服务中路由

此服务包含两个单独服务：邮箱传输提交服务和邮箱传输传递服务。对于传入的邮件，邮箱传输传递服务从传输服务接收 SMTP 邮件，并使用 RPC 连接到本地邮箱数据库以传递邮件。对于传出的邮件，邮箱传输提交服务使用 RPC 连接到本地邮箱数据库以检索邮件，并通过 SMTP 将邮件提交给传输服务。邮箱传输服务没有状态，不在本地对任何邮件进行排队。

与传输服务一样，邮箱传输服务基于来自 Active Directory 的信息加载路由表，并使用传递组确定如何路由邮件。但是，邮箱传输服务有几个特有的路由方面：

  - 因为传输服务和邮箱传输服务位于相同的 Exchange 2013 邮箱服务器上，所以邮箱传输服务始终属于与邮箱服务器相同的传递组。此传递组称为“本地传递组”。

  - 邮箱传输提交服务不会自动将邮件发送给本地邮箱服务器上或自己的本地传递组中的其他邮箱服务器上的传输服务。邮箱传输提交服务可以访问与传输服务相同的路由拓扑信息，因此邮箱传输提交服务可以将邮件发送到传递组外部的邮箱服务器上的传输服务。本地传递组中的邮箱服务器用作回退选项，并用于传递给非邮箱收件人。

  - 邮箱传输服务仅与 Exchange 2013 邮箱服务器上的传输服务通信。

  - 邮箱传输服务仅与本地 Exchange 2013 邮箱服务器上的邮箱数据库通信。邮箱传输服务从不与其他邮箱服务器上的邮箱数据库通信。

当用户从其邮箱发送邮件时，邮箱传输提交服务会将邮件收件人解析为邮箱数据库。邮箱传输提交服务使用的邮箱服务器的列表基于邮件收件人的邮箱数据库。请注意，可能没有任何收件人具有邮箱（例如在收件人为通讯组或邮件用户时）。对于每个邮箱数据库，邮箱传输提交服务会查找传递组和关联路由信息。邮箱传输提交服务使用的传递组为：

  - 可路由 DAG

  - 邮箱传递组

  - AD 站点

根据收件人的数量和类型，邮箱传输提交服务执行以下操作之一：

  - 对于具有单个邮箱收件人的邮件，在目标传递组中选择邮箱服务器，并基于 Active Directory 站点的临近程度向邮箱服务器分配优先权。将邮件路由到收件人可能涉及通过中心站点路由邮件。

  - 对于具有多个邮箱收件人的邮件，使用前 20 个收件人，基于 Active Directory 站点的临近程度在最近的传递组中选择邮箱服务器。

  - 如果邮件没有邮箱收件人，则在本地传递组中选择邮箱服务器。

当邮箱传输传递服务从传输服务接收邮件时，它会接受或拒绝传递给本地邮箱数据库的邮件。如果收件人驻留在本地邮箱数据库的主动副本中，则邮箱传输传递服务可以传递邮件。但是如果收件人不驻留在本地邮箱数据库的主动副本中，则邮箱传输传递服务无法传递邮件，并且必须向传输服务提供未送达响应。例如，如果邮箱数据库的主动副本最近移动到另一台服务器，则传输服务可能错误地将邮件传输到现在保存邮箱数据库非主动副本的邮箱服务器。邮箱传输传递服务返回给传输服务的未送达响应包括：

  - 重试传递

  - 生成 NDR

  - 重新路由邮件

返回顶部

## 在边缘传输服务器上的传输服务中路由

如果您在外围网络中安装了边缘传输服务器，边缘传输服务器中的传输服务可向所有面向 Internet 的邮件流提供 SMTP 中继和智能主机服务。来自 Internet 的邮件和发往 Internet 的邮件在边缘传输服务器上进行本地排队。队列与外部域或发送连接器相对应。有关详细信息，请参阅[队列](queues-exchange-2013-help.md)主题中的“NextHopSolutionKey”一节。

通常，当您在外围网络中安装边缘传输服务器时，会将边缘传输服务器订阅到 Active Directory 站点。Active Directory 站点包含会将邮件中继到边缘传输服务器以及中继来自边缘传输服务器的邮件的邮箱服务器。边缘订阅过程会为边缘传输服务器创建 Active Directory 站点成员身份关联。站点关联使 Active Directory 站点中的邮箱服务器可以将邮件中继到边缘传输服务器，以传递到 Internet，而不必配置显式发送连接器。

在多站点配置中，从内部收件人到外部收件人的出站邮件首先路由到订阅的 Active Directory 站点。目标 Active Directory 站点为传递组。路由目标为订阅的 Active Directory 站点中任何邮箱服务器上的传输服务中的组织内部发送连接器。*组织内部发送连接器*为存在于每个邮箱服务器上的传输服务中的特殊发送连接器。此发送连接器是隐式创建的，不可见，不要求进行管理，并且用于在 Exchange 服务器之间中继邮件。

外部收件人的出站邮件从邮箱服务器路由到边缘传输服务器。客户端访问服务器不参与将邮件路由到订阅的边缘传输服务器。邮件从邮箱服务器上的传输服务中的组织内部发送连接器传输到边缘传输服务器上的传输服务中的接收连接器。在订阅的边缘传输服务器上，默认的接收连接器配置为侦听来自订阅的 Active Directory 站点中内部邮箱服务器的连接和来自 Internet 的匿名连接。邮件由边缘传输服务器上的传输服务进行分类后，将进行本地排队以通过使用在边缘订阅期间创建的专用发送连接器传递到 Internet。

来自外部收件人的入站邮件通过默认接收连接器到达边缘传输，并且对邮件进行分类和排队以便传递。邮件通过专用发送连接器进行中继，该连接器由边缘订阅创建，用于将邮件发送到 Exchange 组织。邮件接下来要传递到的位置取决于内部 Exchange 服务器的配置情况。

  - **安装在同一台计算机上的邮箱服务器和客户端访问服务器**   在此配置中，客户端访问服务器用于入站邮件流。邮件从边缘传输服务器上的传输服务中的发送连接器流至客户端访问服务器上的前端传输服务中的默认接收连接器，然后流至邮箱服务器上的传输服务中的默认接收连接器。

  - **安装在不同计算机上的邮箱服务器和客户端访问服务器**   在此配置中，入站邮件流将绕过客户端访问服务器。邮件从边缘传输服务器上的传输服务中的发送连接器流至邮箱服务器上的传输服务中的默认接收连接器。

如果您在外围网络中安装了 Exchange 2007 或 Exchange 2010 边缘传输服务器，则入站和出站邮件流始终会直接出现在边缘传输服务器和邮箱服务器之间。不使用客户端访问服务器。

返回顶部

